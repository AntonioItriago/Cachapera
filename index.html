<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√∫ El Sabor de la Cachapa</title>
    <style>
        /* ==================================== */
        /* ESTILOS CSS BASE */
        /* ==================================== */
        body { 
            font-family: 'Arial', sans-serif; 
            /* --- FONDO DE PANTALLA (Actualizado) --- */
            background-image: url('fondo_cachapera.png'); 
            background-size: cover; 
            background-attachment: fixed; 
            background-repeat: no-repeat; 
            background-color: #333;
            margin: 0; 
            padding: 20px; 
            color: #333;
        }
        .main-container {
            max-width: 500px;
            margin: 0 auto;
        }
        h1, h2 { 
            text-align: center; 
            color: #d9534f;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        /* --- ESTILOS DEL ENCABEZADO Y LOGO --- */
        .brand-header {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 20px; 
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 10px;
        }
        .brand-logo {
            height: 50px; 
            margin-right: 10px; 
            vertical-align: middle; 
        }
        .brand-name {
            font-size: 1.5em; /* Ajustado para el nombre largo */
            font-weight: bold;
            color: #d9534f; 
            margin: 0; 
            text-align: center;
        }
        /* Estilos de Carrito en el Encabezado */
        .header-carrito { 
            display: flex; 
            justify-content: flex-end; 
            align-items: center; 
            padding: 10px 0; 
            font-weight: bold;
        }
        #contador-carrito { 
            background: #d9534f; 
            color: white; 
            border-radius: 50%; 
            padding: 4px 8px; 
            font-weight: bold; 
            font-size: 12px; 
            margin-left: 5px; 
        }

        /* --- ESTILOS DEL CARRUSEL DE CATEGOR√çAS --- */
        #carrusel-categorias, #detalle-carrito {
            background-color: rgba(255, 255, 255, 0.95); 
            border-radius: 8px;
            padding: 15px; 
            margin-top: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            min-height: 200px;
        }
        .categoria-pagina {
            display: none;
            width: 100%;
        }
        .categoria-pagina.activa {
            display: block;
        }
        .categoria-pagina h3 {
            text-align: center;
            color: #333;
            border-bottom: 2px solid #ffc107;
            padding-bottom: 5px;
            margin: 0 0 15px 0;
            font-size: 1.5em;
        }
        
        /* Controles de navegaci√≥n del carrusel de categor√≠as */
        .nav-categoria-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            z-index: 20;
            font-size: 18px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .nav-categoria-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        #prevCategoriaBtn { left: 5px; }
        #nextCategoriaBtn { right: 5px; }
        #carrusel-categorias.loading-state {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        /* --- ESTILOS DEL MEN√ö ITEM CON IMAGEN --- */
        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed #eee;
        }
        .menu-item:last-child {
            border-bottom: none;
        }
        .menu-item-info {
            flex-grow: 1;
            padding-right: 10px;
            display: flex;
            align-items: center;
        }
        .item-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
            margin-right: 10px;
            border: 1px solid #ddd;
        }
        .item-text {
            flex-grow: 1;
        }
        .item-text strong {
            display: block;
            font-size: 1.1em;
            color: #d9534f;
        }
        .item-text span {
            font-size: 0.9em;
            color: #666;
        }
        
        /* Controles de cantidad (A√±adir/Quitar) */
        .item-carrito-controls {
             display: flex; 
             align-items: center;
             min-width: 100px;
        }
        .item-carrito-controls button {
            background-color: #d9534f;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            font-weight: bold;
        }
        .item-carrito-controls span {
            font-weight: bold;
            padding: 0 5px;
            min-width: 15px;
            text-align: center;
        }
        /* Bot√≥n A√±adir para √≠tems sin cantidad */
        .btn-add {
            background-color: #5cb85c !important; 
            padding: 8px 12px !important;
            border-radius: 4px !important;
            width: auto !important;
            height: auto !important;
            font-size: 1em !important;
            margin: 0;
        }

        /* --- VISTA DEL CARRO --- */
        #detalle-carrito ul { list-style: none; padding: 0; }
        .item-carrito { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
            border-bottom: 1px dotted #eee; 
            padding-bottom: 5px; 
        }
        
        #btn-finalizar {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #25d366; 
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.2s;
        }
        #btn-finalizar:hover {
            background-color: #128c7e;
        }
        
        .footer-note {
            text-align: center; 
            font-size: 0.8em; 
            margin-top: 15px;
            color: white;
            text-shadow: 1px 1px 2px #333;
        }
        .tasa-bcv-display {
            font-weight: bold;
            color: #007bff; /* Un color que destaque */
            display: block;
            margin-bottom: 10px; /* Separaci√≥n debajo de la tasa */
            text-align: center;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<div class="main-container">

    <div class="header-carrito">
        üõí **Tu Carrito** <span id="contador-carrito">0</span>
    </div>
    
    <div id="tasa-bcv-info" class="tasa-bcv-display"></div>
    
    <div class="brand-header">
        <img src="logo_cachapera.png" alt="Logo El Sabor de la Cachapa" class="brand-logo">
        <h1 class="brand-name">El Sabor de la Cachapa</h1>
    </div>

    <h2>MENU</h2>
    <div id="carrusel-categorias" class="loading-state">
        Cargando tasa BCV y men√∫ ...
    </div>

    <button id="prevCategoriaBtn" class="nav-categoria-btn" style="display:none;" onclick="cambiarCategoria(-1)">&#10094;</button>
    <button id="nextCategoriaBtn" class="nav-categoria-btn" style="display:none;" onclick="cambiarCategoria(1)">&#10095;</button>

    <hr style="border-top: 1px solid rgba(255,255,255,0.5);">
    
    <h2>üìã Tu Pedido Final</h2>
    <div id="detalle-carrito">
        <p>El carrito est√° vac√≠o. Empieza a seleccionar tus √≠tems.</p>
    </div>

    <button id="btn-finalizar" onclick="consultarPrecios()">
        Enviar Pedido por WhatsApp
    </button>
    
    <p class="footer-note">
        *La Tasa BCV (mostrada arriba) y el precio final de delivery ser√°n confirmados al enviar el pedido.
    </p>

</div>

<script>
    // URL P√öBLICA DE TU GOOGLE SHEET EXPORTADA COMO CSV
    // **IMPORTANTE:** Aseg√∫rate de que esta URL sea la CORRECTA y que la hoja est√© PUBLICADA.
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsTRhoswf3zopWO5PEusQsYdYglnUlWTX9HzFIvewpy4vED9fQbs9Z0V3EdQ-AGMGLlpmcs_LL_cP3/pub?gid=0&single=true&output=csv';
    
    // API para obtener la tasa BCV en tiempo real (dolarapi.com)
    const BCV_API_URL = 'https://ve.dolarapi.com/v1/dolar';

    // VALOR DE RESPALDO ACTUALIZADO: Tasa BCV oficial para 20/11/2025 (Ejemplo)
    let TASA_BCV_HOY = 251.4883; 
    
    // N√öMERO DE WHATSAPP
    const NUMERO_WHATSAPP = "584122525407"; 

    // SEPARADOR DE COLUMNAS (COMA)
    const CSV_SEPARATOR = ',';
    
    // ORDEN PERSONALIZADO DE CATEGOR√çAS
    const ORDEN_CATEGORIAS_PREFERIDO = [
        "ESPECIALES",
        "COMBOS",
        "ADICIONALES"
    ];

    let carrito = [];
    let productos = []; 
    let productosPorCategoria = {};
    let categoriasOrdenadas = [];
    let categoriaActualIndex = 0;
    
    const carruselContenedor = document.getElementById('carrusel-categorias');
    const secciones = {
        carrito: document.getElementById('detalle-carrito'),
        contador: document.getElementById('contador-carrito'),
        prevBtn: document.getElementById('prevCategoriaBtn'),
        nextBtn: document.getElementById('nextCategoriaBtn'),
        tasaInfo: document.getElementById('tasa-bcv-info')
    };
    
    // ===========================================
    // FUNCIONES PRINCIPALES DE FETCH Y RENDERIZADO
    // ===========================================

    async function fetchTasaBCV() {
        const respaldo = TASA_BCV_HOY;
        let tasaObtenida = respaldo;
        let fuente = "Respaldo";

        try {
            // **Implementaci√≥n de la instrucci√≥n del usuario para BCV**
            // Nota: Aqu√≠ se est√° usando dolarapi como sustituto de bcv.org.ve
            const response = await fetch(BCV_API_URL, { cache: 'no-store' }); 
            if (!response.ok) throw new Error(`API error! status: ${response.status}`);
            
            const data = await response.json();
            
            if (data && data.dolarbcv && data.dolarbcv.promedio) {
                tasaObtenida = parseFloat(data.dolarbcv.promedio);
                fuente = "BCV (API)";
            } else {
                console.warn("API de DolarAPI no devolvi√≥ la tasa BCV esperada. Usando valor de respaldo.");
            }
        } catch (error) {
            console.error("Error al obtener la tasa BCV por API:", error);
        }
        
        TASA_BCV_HOY = tasaObtenida;
        secciones.tasaInfo.innerHTML = `üáªüá™ Tasa BCV: **1$ = ${TASA_BCV_HOY.toFixed(4)} Bs** <small>(${fuente} ${new Date().toLocaleDateString('es-VE')})</small>`;
    }

    async function fetchDataAndRender() {
        // 1. Obtener la tasa BCV
        await fetchTasaBCV(); 

        // 2. Cargar y renderizar el men√∫
        try {
            const response = await fetch(CSV_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const csvText = await response.text();
            parseCSV(csvText);
            
            if (productos.length > 0) {
                agruparProductos();
                renderizarCarrusel();
                actualizarVistaCarrito();
                carruselContenedor.classList.remove('loading-state');
            } else {
                 carruselContenedor.innerHTML = '‚ö†Ô∏è Error: No se encontraron productos o no se pudieron agrupar por categor√≠a. Verifique los datos de su hoja.';
            }

        } catch (error) {
            console.error("Error al cargar o parsear el CSV:", error);
            carruselContenedor.innerHTML = `‚ö†Ô∏è Error al cargar los datos: ${error.message}. Verifica el enlace y el formato de la hoja.`;
        }
    }
    
    function parseCSV(csv) {
        const lineas = csv.trim().split('\n');
        if (lineas.length === 0) return;

        // 1. Obtener y normalizar los encabezados reales del CSV (quitar espacios y a min√∫sculas)
        const encabezados = lineas[0].replace(/\r/g, '').split(CSV_SEPARATOR).map(h => h.trim().toLowerCase());
        
        // 2. Mapear los √≠ndices usando los nombres en min√∫sculas proporcionados por el usuario
        const columnaMap = {
            id: encabezados.indexOf('id'),
            name: encabezados.indexOf('name'),
            price: encabezados.indexOf('price'),
            currency: encabezados.indexOf('currency'),
            category: encabezados.indexOf('category'),
            description: encabezados.indexOf('description'),
            image_url: encabezados.indexOf('image_url')
        };
        
        // √çndice de la columna PRECIO
        const priceIndex = columnaMap.price;

        for (let i = 1; i < lineas.length; i++) {
            const valores = lineas[i].replace(/\r/g, '').split(CSV_SEPARATOR).map(v => v.trim());
            if (valores.length !== encabezados.length) continue; 

            // Verificar que todas las columnas esenciales existan (√≠ndice diferente de -1)
            if (columnaMap.id === -1 || columnaMap.name === -1 || columnaMap.price === -1 || columnaMap.currency === -1 || columnaMap.category === -1) {
                 // Si falla, detener y mostrar un error en la consola
                 if (i === 1) console.error("Faltan columnas esenciales: ", columnaMap);
                 return;
            }

            // --- CORRECCI√ìN DE DECIMALES (COMAS A PUNTOS) ---
            let precioProcesado = valores[priceIndex];
            if (valores[priceIndex] && valores[priceIndex].includes(',')) {
                precioProcesado = valores[priceIndex].replace(',', '.');
            }
            // -----------------------------------------------
            
            // Mapeo de columnas a la estructura de productos
            productos.push({
                id: valores[columnaMap.id],
                nombre: valores[columnaMap.name],
                precio: parseFloat(precioProcesado) || 0, 
                moneda: valores[columnaMap.currency],
                // **CORRECCI√ìN CLAVE:** Asegurarse de que la categor√≠a se use como clave
                categoria: valores[columnaMap.category], 
                descripcion: valores[columnaMap.description] || '', 
                imagenUrl: valores[columnaMap.image_url] || '' 
            });
        }
    }
    
    function agruparProductos() {
        productosPorCategoria = productos.reduce((acc, p) => {
            // **VERIFICACI√ìN CLAVE:** Si p.categoria est√° vac√≠o (null/undefined/''), el producto se ignora
            if (p.categoria && p.categoria.trim() !== '' && p.id) {
                const categoriaKey = p.categoria.toUpperCase(); // Agrupar siempre en may√∫sculas
                if (!acc[categoriaKey]) {
                    acc[categoriaKey] = [];
                }
                acc[categoriaKey].push(p);
            }
            return acc;
        }, {});
        
        // Resto del c√≥digo de ordenamiento...
        let categoriasEncontradas = Object.keys(productosPorCategoria);
        let categoriasRestantes = [...categoriasEncontradas];
        
        categoriasOrdenadas = ORDEN_CATEGORIAS_PREFERIDO.filter(orden => {
            const index = categoriasRestantes.indexOf(orden);
            if (index !== -1) {
                categoriasRestantes.splice(index, 1);
                return true;
            }
            return false;
        });

        categoriasRestantes.sort();
        categoriasOrdenadas = categoriasOrdenadas.concat(categoriasRestantes);
        
        if (categoriasOrdenadas.length > 1) {
            secciones.prevBtn.style.display = 'block';
            secciones.nextBtn.style.display = 'block';
        } else {
            secciones.prevBtn.style.display = 'none';
            secciones.nextBtn.style.display = 'none';
        }
    }

    function renderizarCarrusel() {
        carruselContenedor.innerHTML = '';
        
        if (categoriasOrdenadas.length === 0) {
            carruselContenedor.innerHTML = '‚ö†Ô∏è No hay categor√≠as para mostrar. Verifica que la columna **category** en tu hoja tenga valores para agrupar los productos.';
            return;
        }

        const categoriaActual = categoriasOrdenadas[categoriaActualIndex];
        const productosDeCategoria = productosPorCategoria[categoriaActual];

        let categoriaHTML = `<div class="categoria-pagina activa">`;
        categoriaHTML += `<h3>${categoriaActual}</h3>`;
        
        productosDeCategoria.forEach(producto => {
            const id = producto.id;
            const item = carrito.find(p => p.id === id);
            
            let precioTexto = producto.moneda === '$' ? `$${producto.precio.toFixed(2)}` : `${producto.precio.toFixed(2)} ${producto.moneda}`;
            
            let controlesHTML;
            if (item) {
                controlesHTML = `
                    <div class="item-carrito-controls">
                        <button onclick="cambiarCantidad('${id}', -1)">-</button>
                        <span>${item.cantidad}</span>
                        <button onclick="cambiarCantidad('${id}', 1)">+</button>
                    </div>
                `;
            } else {
                controlesHTML = `<button class="btn-add" onclick="cambiarCantidad('${id}', 1)">‚ûï A√±adir</button>`;
            }

            const imagenTag = producto.imagenUrl ? `<img src="${producto.imagenUrl}" alt="${producto.nombre}" class="item-thumb">` : '';

            categoriaHTML += `
                <div class="menu-item">
                    <div class="menu-item-info">
                        ${imagenTag}
                        <div class="item-text">
                            <strong>${producto.nombre} - ${precioTexto}</strong>
                            <span>${producto.descripcion}</span>
                        </div>
                    </div>
                    ${controlesHTML}
                </div>
            `;
        });

        categoriaHTML += '</div>';
        carruselContenedor.innerHTML = categoriaHTML;
    }

    function cambiarCategoria(delta) {
        let nuevoIndex = categoriaActualIndex + delta;
        
        if (nuevoIndex >= 0 && nuevoIndex < categoriasOrdenadas.length) {
            categoriaActualIndex = nuevoIndex;
        } else if (nuevoIndex < 0) {
            categoriaActualIndex = categoriasOrdenadas.length - 1;
        } else if (nuevoIndex >= categoriasOrdenadas.length) {
            categoriaActualIndex = 0;
        }
        renderizarCarrusel();
    }
    
    function cambiarCantidad(productoId, delta) {
        let itemIndex = carrito.findIndex(item => item.id === productoId);
        const productoAAgregar = productos.find(p => p.id === productoId);

        if (!productoAAgregar) return;
        
        if (itemIndex === -1) {
            if (delta > 0) {
                carrito.push({
                    ...productoAAgregar,
                    cantidad: delta
                });
            }
        } else {
            let nuevoCantidad = carrito[itemIndex].cantidad + delta;
            if (nuevoCantidad > 0) {
                carrito[itemIndex].cantidad = nuevoCantidad;
            } else {
                carrito.splice(itemIndex, 1);
            }
        }

        actualizarVistaCarrito();
        renderizarCarrusel(); 
    }
    
    function calcularTotalItems() {
      return carrito.reduce((total, item) => total + item.cantidad, 0);
    }

    function actualizarVistaCarrito() {
        const totalItems = calcularTotalItems();
        secciones.contador.textContent = totalItems;
        
        secciones.carrito.innerHTML = ''; 

        if (carrito.length === 0) {
            secciones.carrito.innerHTML = '<p>El carrito est√° vac√≠o. ¬°Empieza a seleccionar tus √≠tems!</p>';
            return;
        }

        let contenidoHTML = '<ul>';
        let totalPagarUSD = 0;
        let totalPagarBS = 0;

        carrito.forEach(item => {
            let subtotal = item.precio * item.cantidad;
            
            if (item.moneda === '$') {
                totalPagarUSD += subtotal;
                totalPagarBS += subtotal * TASA_BCV_HOY;
            } else {
                totalPagarBS += subtotal;
                totalPagarUSD += subtotal / TASA_BCV_HOY; 
            }
            
            let precioUnitario = item.moneda === '$' ? `$${item.precio.toFixed(2)}` : `${item.precio.toFixed(2)} ${item.moneda}`;
            let subtotalFormateado = item.moneda === '$' ? `$${subtotal.toFixed(2)}` : `${subtotal.toFixed(2)} ${item.moneda}`;


            contenidoHTML += `
                <li class="item-carrito">
                    <span>
                        **${item.cantidad}x** ${item.nombre} 
                        <br>
                        <small>(${precioUnitario})</small>
                    </span>
                    <strong>${subtotalFormateado}</strong>
                </li>
            `;
        });
        
        const totalUSD = totalPagarUSD.toFixed(2);
        const totalBS = totalPagarBS.toFixed(2);
        
        contenidoHTML += `</ul>
            <hr>
            <p><strong>Total (Aprox. en $): $${totalUSD}</strong></p>
            <p><strong>Total (Aprox. en Bs): ${totalBS} Bs</strong> <small>(Tasa BCV: ${TASA_BCV_HOY.toFixed(4)})</small></p>
            <small>‚ö†Ô∏è Estos totales son referenciales. El precio en Bol√≠vares se calcular√° con la tasa del momento al enviar el pedido.</small>
        `;

        secciones.carrito.innerHTML = contenidoHTML;
    }
    
    function consultarPrecios() {
        if (carrito.length === 0) {
            alert("Tu carrito est√° vac√≠o. ¬°Agrega productos para hacer tu pedido!");
            return;
        }

        let mensaje = `¬°Hola! Me gustar√≠a hacer un pedido desde el men√∫ *El Sabor de la Cachapa*.\n\n`;
        let totalUSD = 0;
        
        mensaje += `*üõí Mi Pedido:*\n`;
        carrito.forEach(item => {
            const subtotal = item.precio * item.cantidad;
            
            if (item.moneda === '$') {
                totalUSD += subtotal;
                mensaje += `- ${item.cantidad}x ${item.nombre} ($${subtotal.toFixed(2)})\n`;
            } else {
                totalUSD += subtotal / TASA_BCV_HOY;
                mensaje += `- ${item.cantidad}x ${item.nombre} (${subtotal.toFixed(2)} ${item.moneda})\n`;
            }
        });

        const totalFinalUSD = totalUSD.toFixed(2);
        const totalFinalBS = (totalUSD * TASA_BCV_HOY).toFixed(2);
        
        mensaje += `\n*üíµ Total Aproximado:* $${totalFinalUSD}`;
        mensaje += `\n*üáªüá™ Tasa BCV Usada:* ${TASA_BCV_HOY.toFixed(4)}`;
        mensaje += `\n*üáªüá™ Total Aproximado:* ${totalFinalBS} Bs`;
        mensaje += `\n\n*Por favor, conf√≠rmenme el precio final incluyendo el delivery, si aplica.*`;


        const url = `https://wa.me/${NUMERO_WHATSAPP}?text=${encodeURIComponent(mensaje)}`;
        window.open(url, '_blank');
    }
    
    // ===========================================
    // INICIALIZACI√ìN
    // ===========================================
    document.addEventListener('DOMContentLoaded', fetchDataAndRender);
</script>
</body>
</html>
